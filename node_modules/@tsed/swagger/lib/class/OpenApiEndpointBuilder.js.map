{"version":3,"sources":["../src/swagger/class/OpenApiEndpointBuilder.ts"],"names":[],"mappings":"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","file":"OpenApiEndpointBuilder.js","sourcesContent":["import {EndpointMetadata, PathParamsType} from \"@tsed/common\";\nimport {deepExtends, Store} from \"@tsed/core\";\nimport {Operation, Path, Response} from \"swagger-schema-official\";\nimport {OpenApiResponses} from \"../interfaces/OpenApiResponses\";\nimport {parseSwaggerPath} from \"../utils\";\nimport {OpenApiModelSchemaBuilder} from \"./OpenApiModelSchemaBuilder\";\nimport {OpenApiParamsBuilder} from \"./OpenApiParamsBuilder\";\n\n/** */\n\nexport class OpenApiEndpointBuilder extends OpenApiModelSchemaBuilder {\n  private _paths: {[pathName: string]: Path} = {};\n\n  constructor(\n    private endpoint: EndpointMetadata,\n    private endpointUrl: string,\n    private pathMethod: {path?: PathParamsType; method?: string},\n    private getOperationId: Function\n  ) {\n    super(endpoint.target);\n  }\n\n  /**\n   *\n   * @returns {this}\n   */\n  build(): this {\n    parseSwaggerPath(this.endpointUrl, this.pathMethod.path).forEach(({path: endpointPath, pathParams}) => {\n      const builder = new OpenApiParamsBuilder(this.endpoint.target, this.endpoint.methodClassName, pathParams).build();\n\n      const path: any = this._paths[endpointPath] || {};\n\n      path[this.pathMethod.method!] = this.createOperation(builder);\n\n      Object.assign(this._definitions, builder.definitions);\n\n      this._paths[endpointPath] = path;\n    });\n\n    return this;\n  }\n\n  /**\n   *\n   * @param {OpenApiResponses} builderResponses\n   * @returns {OpenApiResponses}\n   */\n  private createResponses(builderResponses: OpenApiResponses): OpenApiResponses {\n    const responses = this.endpoint.get(\"responses\") || {};\n\n    deepExtends(responses, builderResponses);\n\n    responses[this.endpoint.get(\"statusCode\") || \"200\"] = {description: \"Success\"};\n\n    Object.keys(responses).forEach(code => {\n      responses[code] = this.createResponse(code, responses[code]);\n    });\n\n    return responses;\n  }\n\n  /**\n   *\n   * @returns {Operation}\n   * @param builder\n   */\n  private createOperation(builder: OpenApiParamsBuilder): Operation {\n    const operationId = this.getOperationId(`${this.endpoint.targetName}.${this.endpoint.methodClassName}`);\n    const security = this.endpoint.get(\"security\") || [];\n    const produces = this.endpoint.get(\"produces\") || [];\n    const consumes = this.endpoint.get(\"consumes\") || [];\n\n    return deepExtends(\n      {\n        operationId,\n        tags: [this.getTagName()],\n        parameters: builder.parameters,\n        consumes,\n        responses: this.createResponses(builder.responses),\n        security,\n        produces\n      },\n      this.endpoint.get(\"operation\") || {}\n    );\n  }\n\n  /**\n   *\n   * @returns {string}\n   */\n  private getTagName(): string {\n    const clazz = this.endpoint.target;\n    const ctrlStore = Store.from(clazz);\n    const tag = ctrlStore.get(\"tag\");\n    const name = ctrlStore.get(\"name\");\n\n    return name || (tag && tag.name) || this.endpoint.targetName;\n  }\n\n  /**\n   *\n   * @param {string | number} code\n   * @param options\n   * @returns {Response}\n   */\n  private createResponse(code: string | number, options: Response): Response {\n    const {description, headers, examples} = deepExtends(options, this.endpoint.statusResponse(code) || {});\n\n    const response: Response = {description, headers, examples};\n\n    if (this.endpoint.type === undefined) {\n      return response;\n    }\n\n    response.schema = this.createSchema(this.endpoint);\n\n    return response;\n  }\n\n  /**\n   *\n   * @returns {}\n   */\n  public get paths(): {[p: string]: Path} {\n    return this._paths;\n  }\n}\n"],"sourceRoot":"../../"}